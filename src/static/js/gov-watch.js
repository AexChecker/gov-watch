// Generated by IcedCoffeeScript 1.2.0i
(function() {
  var BOOK, SEARCHTERM, SLUG, all_books, all_subjects, all_tags, data_callback, do_search, generate_hash, generate_url, iced, initialized, load_data, loaded_data, onhashchange, process_data, run_templates, search_term, select_item, selected_book, selected_slug, set_fb_title, setup_searchbox, setup_summary, setup_timeline, show_watermark, skip_overview, slugify, status_filter, unslugify, update_history, wm_shown, __iced_k,
    __slice = [].slice;

  iced = {
    Deferrals: (function() {

      function _Class(_arg) {
        this.continuation = _arg;
        this.count = 1;
        this.ret = null;
      }

      _Class.prototype._fulfill = function() {
        if (!--this.count) return this.continuation(this.ret);
      };

      _Class.prototype.defer = function(defer_params) {
        var _this = this;
        ++this.count;
        return function() {
          var inner_params, _ref;
          inner_params = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          if (defer_params != null) {
            if ((_ref = defer_params.assign_fn) != null) {
              _ref.apply(null, inner_params);
            }
          }
          return _this._fulfill();
        };
      };

      return _Class;

    })(),
    findDeferral: function() {
      return null;
    }
  };
  __iced_k = function() {};

  loaded_data = null;

  all_books = [];

  all_tags = [];

  all_subjects = [];

  selected_book = "";

  search_term = "";

  selected_slug = "";

  skip_overview = false;

  BOOK = 'b';

  SLUG = 's';

  SEARCHTERM = 't';

  status_filter = null;

  slugify = function(str) {
    var ch, co, str2, x, _i, _ref;
    str2 = "";
    if (str === "") return "";
    for (x = _i = 0, _ref = str.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; x = 0 <= _ref ? ++_i : --_i) {
      ch = str.charAt(x);
      co = str.charCodeAt(x);
      if (co >= 0x5d0 && co < 0x600) co = co - 0x550;
      if (co < 256) str2 += (co + 0x100).toString(16).substr(-2).toUpperCase();
    }
    return str2;
  };

  unslugify = function(str) {
    var ch, str2, x, _i, _ref;
    str2 = "";
    if (str === "") return "";
    for (x = _i = 0, _ref = (str.length / 2) - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; x = 0 <= _ref ? ++_i : --_i) {
      ch = str.slice(x * 2, (x * 2 + 1) + 1 || 9e9);
      ch = parseInt(ch, 16);
      if (ch >= 128) ch += 0x550;
      str2 = str2 + String.fromCharCode(ch);
    }
    return str2;
  };

  generate_hash = function(selected_book, search_term, slug) {
    if (slug) {
      return "!z=" + BOOK + ":" + (slugify(selected_book)) + "|" + SLUG + ":" + slug;
    } else {
      return "!z=" + BOOK + ":" + (slugify(selected_book)) + "|" + SEARCHTERM + ":" + (slugify(search_term));
    }
  };

  generate_url = function(slug) {
    return "http://" + window.location.host + "/#" + (generate_hash(selected_book, "", slug));
  };

  update_history = function(slug) {
    var ___iced_passed_deferral, __iced_deferrals,
      _this = this;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    (function(__iced_k) {
      __iced_deferrals = new iced.Deferrals(__iced_k, {
        parent: ___iced_passed_deferral,
        filename: 'gov-watch.iced',
        funcname: 'update_history'
      });
      setTimeout((__iced_deferrals.defer({
        assign_fn: (function() {
          return function() {
            return __iced_deferrals.ret = arguments[0];
          };
        })(),
        lineno: 56
      })), 0);
      __iced_deferrals._fulfill();
    })(function() {
      return window.location.hash = generate_hash(selected_book, search_term, slug);
    });
  };

  set_fb_title = function(title) {
    $("title").html(title);
    return $("meta[property='og:title']").attr("content", title);
  };

  onhashchange = function() {
    var fullhash, hash, key, part, slug, splits, value, _i, _len, _ref;
    fullhash = window.location.hash;
    hash = fullhash.slice(4, fullhash.length);
    splits = hash.split("|");
    slug = null;
    selected_book = null;
    search_term = "";
    for (_i = 0, _len = splits.length; _i < _len; _i++) {
      part = splits[_i];
      _ref = part.split(":"), key = _ref[0], value = _ref[1];
      if (key === BOOK) selected_book = unslugify(value);
      if (key === SLUG) slug = value;
      if (key === SEARCHTERM) search_term = unslugify(value);
    }
    if (!selected_book && !slug) {
      selected_book = all_books[0];
      update_history();
      return;
    }
    $("#books li.book").toggleClass('active', false);
    $("#books li.book[data-book='" + selected_book + "']").toggleClass('active', true);
    if (search_term !== "") {
      show_watermark(false);
      $("#searchbox").val(search_term);
    }
    if (slug) {
      selected_slug = slug;
      select_item(selected_slug);
      $(".item").removeClass("shown");
      $("#items").isotope({
        filter: ".shown"
      });
    } else {
      set_fb_title('דו"ח טרכטנברג | המפקח: מעקב אחר ישום המלצות הועדה');
      selected_slug = null;
      select_item(null);
      do_search();
    }
    return _gaq.push(['_trackPageview', '/'+fullhash]);;
  };

  wm_shown = false;

  show_watermark = function(show) {
    if (show) {
      $("#searchbox").val("חיפוש חופשי בתוך ההמלצות");
    } else {
      if (wm_shown) $("#searchbox").val("");
    }
    wm_shown = show;
    return $("#searchbox").toggleClass('watermark', show);
  };

  data_callback = function(data) {
    var gov_updates, k, l, num_links, rec, tag, u, v, watch_updates, _i, _j, _k, _l, _len, _len2, _len3, _len4, _ref, _ref2, _ref3, _ref4, _ref5;
    loaded_data = data;
    all_books = {};
    all_tags = {};
    all_subjects = {};
    for (_i = 0, _len = data.length; _i < _len; _i++) {
      rec = data[_i];
      num_links = {};
      if (!all_books[rec.base.book]) all_books[rec.base.book] = {};
      all_books[rec.base.book][rec.base.chapter] = true;
      _ref = rec.base.tags;
      for (_j = 0, _len2 = _ref.length; _j < _len2; _j++) {
        tag = _ref[_j];
        all_tags[tag] = 1;
      }
      all_subjects[rec.base.subject] = 1;
      gov_updates = [];
      watch_updates = [];
      _ref2 = rec.updates;
      for (k in _ref2) {
        v = _ref2[k];
        for (_k = 0, _len3 = v.length; _k < _len3; _k++) {
          u = v[_k];
          u.user = k;
          if (k === 'gov') {
            gov_updates.push(u);
          } else {
            watch_updates.push(u);
          }
          if (u.links) {
            _ref3 = u.links;
            for (_l = 0, _len4 = _ref3.length; _l < _len4; _l++) {
              l = _ref3[_l];
              num_links[l.url] = true;
            }
          }
        }
      }
      rec.base.num_links = Object.keys(num_links).length;
      rec.gov_updates = gov_updates;
      rec.watch_updates = watch_updates;
      rec.base.subscribers = (_ref4 = rec.subscribers) != null ? _ref4 : 0;
      if (((_ref5 = rec.base.recommendation) != null ? _ref5.length : void 0) > 500) {
        rec.base.recommendation_shortened = rec.base.recommendation.slice(0, 501) + "&nbsp;" + ("<a href='" + (generate_url(rec.slug)) + "'>") + "עוד..." + "</a>";
      }
    }
    all_tags = Object.keys(all_tags);
    all_subjects = Object.keys(all_subjects);
    all_books = Object.keys(all_books);
    if (localStorage) {
      localStorage.data = JSON.stringify(data);
      localStorage.all_books = JSON.stringify(all_books);
      localStorage.all_tags = JSON.stringify(all_tags);
      localStorage.all_subjects = JSON.stringify(all_subjects);
    }
    return process_data();
  };

  initialized = false;

  setup_searchbox = function() {
    var source, subject, tag, _i, _j, _len, _len2;
    show_watermark(true);
    $("#searchbox").change(function() {
      if (wm_shown) {
        search_term = "";
      } else {
        search_term = $("#searchbox").val();
      }
      return update_history();
    });
    $("#searchbox").focus(function() {
      return show_watermark(false);
    });
    $("#searchbox").blur(function() {
      if ($(this).val() === "") return show_watermark(true);
    });
    $("#searchbar").submit(function() {
      return false;
    });
    source = [];
    for (_i = 0, _len = all_tags.length; _i < _len; _i++) {
      tag = all_tags[_i];
      source.push({
        type: "tag",
        title: tag
      });
    }
    for (_j = 0, _len2 = all_subjects.length; _j < _len2; _j++) {
      subject = all_subjects[_j];
      source.push({
        type: "subject",
        title: subject
      });
    }
    return $("#searchbox").typeahead({
      source: source,
      items: 20,
      matcher: function(item) {
        return ~item.title.indexOf(this.query);
      },
      valueof: function(item) {
        return item.title;
      },
      selected: function(val) {
        search_term = val;
        return update_history();
      },
      highlighter: function(item) {
        var highlighted_title;
        highlighted_title = item.title.replace(new RegExp('(' + this.query + ')', 'ig'), function($1, match) {
          return '<strong>' + match + '</strong>';
        });
        if (item.type === "subject") return highlighted_title;
        if (item.type === "tag") {
          return "<span class='searchtag'><span>" + highlighted_title + "</span></span>";
        }
      }
    });
  };

  run_templates = function(template, data, selector) {
    var html;
    template = $("script[name=" + template + "]").html();
    html = Mustache.to_html(template, data);
    return $(selector).html(html);
  };

  setup_timeline = function() {
    return $(".item").each(function() {
      var available_height, conflict, conflict_status, el, gov_status, has_unknowns, height, i, implementation_status, is_good_status, item_size, last_percent, last_update, late, line, margins, max_numeric_date, min_numeric_date, pad, point, remove_line, stamp, stamp_class, status, status_to_hebrew, status_to_stamp_class, timeline_items, today, today_date, top, _i, _ref, _ref2, _ref3;
      pad = function(n) {
        if (n < 10) {
          return '0' + n;
        } else {
          return n;
        }
      };
      today = new Date();
      today = "" + (today.getFullYear()) + "/" + (pad(today.getMonth() + 1)) + "/" + (pad(today.getDate() + 1));
      max_numeric_date = 0;
      min_numeric_date = 2100 * 372;
      $(this).find('.timeline .timeline-point.today').attr('data-date', today);
      has_unknowns = false;
      $(this).find(".timeline > ul > li").each(function() {
        var d, date, day, hour, min, month, numeric_date, second, t, time, year, _ref, _ref2;
        date = $(this).find('.timeline-point:first').attr('data-date');
        date = date.split(' ');
        if (date.length > 1) {
          time = date[1];
        } else {
          time = "00:00:00";
        }
        date = date[0].split('/');
        time = time.split(':');
        _ref = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = date.length; _i < _len; _i++) {
            d = date[_i];
            _results.push(parseInt(d, 10));
          }
          return _results;
        })(), year = _ref[0], month = _ref[1], day = _ref[2];
        _ref2 = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = time.length; _i < _len; _i++) {
            t = time[_i];
            _results.push(parseInt(t, 10));
          }
          return _results;
        })(), hour = _ref2[0], min = _ref2[1], second = _ref2[2];
        numeric_date = (year * 372) + ((month - 1) * 31) + (day - 1) + hour / 24.0 + min / (24.0 * 60) + second / (24 * 60 * 60.0);
        if (isNaN(numeric_date) || (year === 1970)) {
          numeric_date = "xxx";
          has_unknowns = true;
        } else {
          if (numeric_date > max_numeric_date) max_numeric_date = numeric_date;
          if (numeric_date < min_numeric_date) min_numeric_date = numeric_date - 1;
        }
        return $(this).attr('data-date-numeric', numeric_date);
      });
      if (has_unknowns) {
        max_numeric_date += 180;
        $(this).find(".timeline > ul > li[data-date-numeric='xxx']").attr('data-date-numeric', max_numeric_date);
      }
      $(this).find(".timeline > ul > li").tsort({
        attr: 'data-date-numeric',
        order: 'desc'
      });
      status_to_hebrew = function(status) {
        switch (status) {
          case "NEW":
            return "טרם התחיל";
          case "STUCK":
            return "תקוע";
          case "IN_PROGRESS":
            return "בתהליך";
          case "FIXED":
            return "יושם במלואו";
          case "WORKAROUND":
            return "יושם חלקית";
          case "IRRELEVANT":
            return "יישום ההמלצה כבר לא נדרש";
        }
      };
      is_good_status = function(status) {
        switch (status) {
          case "NEW":
            return false;
          case "STUCK":
            return false;
          case "IN_PROGRESS":
            return true;
          case "FIXED":
            return true;
          case "WORKAROUND":
            return false;
          case "IRRELEVANT":
            return true;
        }
      };
      gov_status = 'NEW';
      last_percent = 0.0;
      item_size = 15;
      margins = 80;
      height = $(this).innerHeight() - margins;
      available_height = height;
      $(this).find(".timeline > ul > li .timeline-point").each(function() {
        return available_height = available_height - $(this).outerHeight();
      });
      top = 0;
      conflict = false;
      conflict_status = null;
      remove_line = false;
      late = false;
      timeline_items = $(this).find(".timeline > ul > li");
      if ((timeline_items.length > 1) && $(timeline_items[0]).find('.timeline-point').hasClass('today')) {
        today_date = parseInt($(timeline_items[0]).attr('data-date-numeric'));
        last_update = parseInt($(timeline_items[1]).attr('data-date-numeric'));
        if (today_date - last_update > 180) late = true;
      }
      for (i = _i = _ref = timeline_items.size() - 1; _ref <= 0 ? _i <= 0 : _i >= 0; i = _ref <= 0 ? ++_i : --_i) {
        el = $(timeline_items[i]);
        point = el.find('.timeline-point:first');
        line = el.find('.timeline-line:first');
        status = (_ref2 = point.attr('data-status')) != null ? _ref2 : gov_status;
        if (point.hasClass('gov-update')) {
          conflict = false;
          gov_status = status != null ? status : gov_status;
        }
        if (!remove_line) {
          point.addClass("gov-" + gov_status);
          if (is_good_status(gov_status)) {
            point.addClass("gov-status-good");
          } else {
            point.addClass("gov-status-bad");
          }
          if (conflict) point.addClass("conflict");
        }
        if (point.hasClass("today") || gov_status === "FIXED" || gov_status === "IRRELEVANT") {
          remove_line = true;
        }
        if (remove_line) {
          line.css('border', "none");
          line.css('background', "none");
        } else {
          line.addClass("status-" + gov_status);
          timeline_items.find(".timeline-line").removeClass("unreported");
          line.addClass("unreported");
        }
        if (point.hasClass('watch-update')) {
          if (is_good_status(gov_status) !== is_good_status(status)) {
            conflict = true;
            conflict_status = status;
          }
          if (is_good_status(status)) {
            point.addClass("watch-status-good");
          } else {
            point.addClass("watch-status-bad");
          }
        }
        point.find('.implementation-status').addClass("label-" + status);
        point.find('.implementation-status').html(status_to_hebrew(status));
      }
      $(this).find(".timeline > ul > li").each(function() {
        var date, item_height, percent, point_size;
        point = $(this).find('.timeline-point:first');
        line = $(this).find('.timeline-line:first');
        date = parseInt($(this).attr('data-date-numeric'));
        percent = (max_numeric_date - date) / (max_numeric_date - min_numeric_date);
        point_size = point.outerHeight();
        item_height = available_height * (percent - last_percent) + point_size;
        $(this).css('height', item_height);
        $(this).css('top', top);
        last_percent = percent;
        return top = top + item_height;
      });
      $(this).find(".timeline > ul > li:first > .timeline-line").remove();
      $(this).find(".timeline > ul > li:first").css('height', '3px');
      implementation_status = (_ref3 = $(this).find('.gov-update:last').attr('data-status')) != null ? _ref3 : "NEW";
      if (conflict) {
        $(this).find('.buxa-header').addClass('conflict');
      } else {
        $(this).find('.buxa-header').removeClass('conflict');
        if (is_good_status(implementation_status)) {
          $(this).find('.buxa-header').addClass('good');
        } else {
          $(this).find('.buxa-header').addClass('bad');
        }
      }
      $(this).attr('data-implementation-status', implementation_status);
      $(this).addClass("implementation-status-" + implementation_status);
      status_to_stamp_class = function(status) {
        switch (status) {
          case "NEW":
            return "notstarted";
          case "STUCK":
            return "stuck";
          case "IN_PROGRESS":
            return "inprogress";
          case "FIXED":
            return "done";
          case "WORKAROUND":
            return "workaround";
          case "IRRELEVANT":
            return "done";
        }
      };
      stamp_class = status_to_stamp_class(implementation_status);
      if (late) stamp_class = 'late';
      $(this).find('.buxa-header').after("<div class='stamp " + stamp_class + "'></div>");
      if (conflict) {
        stamp = status_to_hebrew(conflict_status);
        stamp_class = status_to_stamp_class(conflict_status);
        return $(this).find('.buxa-header').after("<div class='stamp conflicting " + stamp_class + "'></div>");
      }
    });
  };

  setup_summary = function() {
    var data, fixed, implemented, in_progress, irrelevant, news, stuck, total, workaround;
    total = $(".item.shown").size();
    stuck = $(".item.shown[data-implementation-status='STUCK']").size();
    news = $(".item.shown[data-implementation-status='NEW']").size();
    in_progress = $(".item.shown[data-implementation-status='IN_PROGRESS']").size();
    fixed = $(".item.shown[data-implementation-status='FIXED']").size();
    workaround = $(".item.shown[data-implementation-status='WORKAROUND']").size();
    irrelevant = $(".item.shown[data-implementation-status='IRRELEVANT']").size();
    data = {};
    if (total) data.total = total;
    stuck = news + workaround + stuck;
    if (stuck) data.stuck = stuck;
    implemented = fixed + irrelevant;
    if (implemented) data.implemented = implemented;
    if (in_progress) data.in_progress = in_progress;
    run_templates("summary", data, "#summary");
    $("#summary .total").click(function() {
      status_filter = null;
      return do_search();
    });
    $("#summary .stuck").click(function() {
      status_filter = ['STUCK', 'NEW', 'WORKAROUND'];
      return do_search();
    });
    $("#summary .implemented").click(function() {
      status_filter = ['FIXED', 'IRRELEVANT'];
      return do_search();
    });
    return $("#summary .in_progress").click(function() {
      status_filter = ['IN_PROGRESS'];
      return do_search();
    });
  };

  process_data = function() {
    var book, explanation_needed, ___iced_passed_deferral, __iced_deferrals, _i, _len,
      _this = this;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    if (initialized) return;
    initialized = true;
    for (_i = 0, _len = all_books.length; _i < _len; _i++) {
      book = all_books[_i];
      $("#books").prepend("<li data-book='" + book + "' class='book'><a href='#'>" + book + "</a></li>");
    }
    run_templates("item", {
      items: loaded_data
    }, "#items");
    explanation_needed = true;
    if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.explained : void 0) != null) {
      explanation_needed = false;
    }
    $("#items").prepend($("#explanation-holder").html());
    $("#explanation-holder").html('');
    $("#explanation").toggleClass('always-shown', explanation_needed);
    $("#clear-explanation").click(function() {
      if (typeof localStorage !== "undefined" && localStorage !== null) {
        localStorage.explained = true;
      }
      $("#explanation").removeClass('always-shown');
      return do_search();
    });
    $("#items").prepend($("#hero-unit-holder").html());
    $("#hero-unit-holder").html('');
    (function(__iced_k) {
      __iced_deferrals = new iced.Deferrals(__iced_k, {
        parent: ___iced_passed_deferral,
        filename: 'gov-watch.iced',
        funcname: 'process_data'
      });
      setTimeout((__iced_deferrals.defer({
        assign_fn: (function() {
          return function() {
            return __iced_deferrals.ret = arguments[0];
          };
        })(),
        lineno: 480
      })), 50);
      __iced_deferrals._fulfill();
    })(function() {
      $.Isotope.prototype._positionAbs = function(x, y) {
        return {
          right: x,
          top: y
        };
      };
      $("#items").isotope({
        itemSelector: '.isotope-card',
        layoutMode: 'masonry',
        transformsEnabled: false,
        filter: ".shown",
        getSortData: {
          followers: function(e) {
            return -parseInt("0" + e.find('.watch').text());
          },
          recommendation: function(e) {
            return e.find('.recommendation-text').text();
          },
          budget: function(e) {
            return -parseInt("0" + e.attr('cost'), 10);
          },
          comments: function(e) {
            return -parseInt("0" + e.find('.fb_comments_count').text(), 10);
          }
        }
      });
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: 'gov-watch.iced',
          funcname: 'process_data'
        });
        setTimeout((__iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              return __iced_deferrals.ret = arguments[0];
            };
          })(),
          lineno: 501
        })), 50);
        __iced_deferrals._fulfill();
      })(function() {
        setup_timeline();
        $(".item").css('visibility', 'inherit');
        setup_searchbox();
        $("#books li.book a").click(function() {
          selected_book = $(this).html();
          return update_history();
        });
        $("#sort button").click(function() {
          var sort_measure;
          $("#sort button").removeClass('active');
          $(this).addClass('active');
          sort_measure = $(this).attr('value');
          return $("#items").isotope({
            sortBy: sort_measure
          });
        });
        $(".hero-unit .hero-size-control").click(function() {
          $(".hero-unit").toggleClass("expanded");
          $("#items").isotope('reLayout');
          return false;
        });
        window.onhashchange = onhashchange;
        return onhashchange();
      });
    });
  };

  select_item = function(slug) {
    var item, url, x, _i, _len, _results;
    $('fb\\:comments').remove();
    $('fb\\:like').remove();
    if (slug) {
      _results = [];
      for (_i = 0, _len = loaded_data.length; _i < _len; _i++) {
        x = loaded_data[_i];
        if (x.slug === slug) {
          item = run_templates("single-item", x, "#single-item");
          set_fb_title(x.base.book + ": " + x.base.subject);
          url = generate_url(slug);
          $("#single-item").append("<fb:like href='" + url + "' send='true' width='590' show_faces='true' action='recommend' font='tahoma'></fb:like>");
          $("#single-item").append("<fb:comments href='" + url + "' num_posts='2' width='590'></fb:comments>");
          if (window.FB) FB.XFBML.parse(item.get(0), function() {});
          break;
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    } else {
      return $("#single-item").html('');
    }
  };

  do_search = function() {
    var class_filter, found, re, rec, should_show, slug, st, tag, x, _i, _j, _k, _len, _len2, _len3, _ref, _ref2;
    re = RegExp(search_term, "ig");
    for (_i = 0, _len = loaded_data.length; _i < _len; _i++) {
      rec = loaded_data[_i];
      slug = rec.slug;
      rec = rec.base;
      should_show = search_term === "";
      if (search_term !== "") {
        _ref = [rec["recommendation"], rec["subject"], rec["result_metric"], rec["title"], rec["chapter"], rec["subchapter"], rec["responsible_authority"]["main"], rec["responsible_authority"]["secondary"]];
        for (_j = 0, _len2 = _ref.length; _j < _len2; _j++) {
          x = _ref[_j];
          if (x) {
            found = x.indexOf(search_term) >= 0;
          } else {
            found = false;
          }
          should_show = should_show || found;
        }
        _ref2 = rec.tags;
        for (_k = 0, _len3 = _ref2.length; _k < _len3; _k++) {
          tag = _ref2[_k];
          if (tag === search_term) should_show = true;
        }
      }
      should_show = should_show && ((selected_book === "") || (rec.book === selected_book)) && (!selected_slug);
      $(".item[rel=" + slug + "]").toggleClass("shown", should_show);
    }
    setup_summary();
    if (status_filter) {
      class_filter = [
        (function() {
          var _l, _len4, _results;
          _results = [];
          for (_l = 0, _len4 = status_filter.length; _l < _len4; _l++) {
            st = status_filter[_l];
            _results.push(".shown.implementation-status-" + st);
          }
          return _results;
        })()
      ];
      class_filter = class_filter.join(",");
    } else {
      class_filter = ".shown";
    }
    class_filter = class_filter + ",.always-shown";
    $("#items").isotope({
      filter: class_filter
    });
    return $("#items").isotope("reLayout");
  };

  load_data = function() {
    return $.get("/api", data_callback, "json");
  };

  $(function() {
    var current_version, version, ___iced_passed_deferral, __iced_deferrals,
      _this = this;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    try {
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: 'gov-watch.iced'
        });
        $.get("/api/version", (__iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              return version = arguments[0];
            };
          })(),
          lineno: 617
        })), "json");
        __iced_deferrals._fulfill();
      })(function() {
        current_version = localStorage.version;
        localStorage.version = JSON.stringify(version);
        if (current_version && version !== JSON.parse(current_version)) {
          loaded_data = JSON.parse(localStorage.data);
          all_books = JSON.parse(localStorage.all_books);
          all_tags = JSON.parse(localStorage.all_tags);
          all_subjects = JSON.parse(localStorage.all_subjects);
          return process_data();
        } else {
          return load_data();
        }
      });
    } catch (error) {
      return load_data();
    }
  });

}).call(this);
