// Generated by IcedCoffeeScript 1.2.0i
((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=[].slice;k={Deferrals:function(){function a(a){this.continuation=a;this.count=1;this.ret=null}a.prototype._fulfill=function(){if(!--this.count)return this.continuation(this.ret)};a.prototype.defer=function(a){var b=this;++this.count;return function(){var c,d;c=1<=arguments.length?A.call(arguments,0):[];a!=null&&(d=a.assign_fn)!=null&&d.apply(null,c);return b._fulfill()}};return a}(),findDeferral:function(){return null}};z=function(){};n=null;d=[];f=[];e=[];s="";q="";t="";w=!1;a="b";c="s";b="t";i=function(d,e,f){return f?"!z="+a+":"+d+"|"+b+":"+e+"|"+c+":"+f:"!z="+a+":"+d+"|"+b+":"+e};j=function(a){return"http://"+window.location.host+"/#"+i("","","",a)};x=function(a){var b,c,d=this;b=k.findDeferral(arguments);(function(a){c=new k.Deferrals(a,{parent:b,filename:"gov-watch.iced",funcname:"update_history"});setTimeout(c.defer({assign_fn:function(){return function(){return c.ret=arguments[0]}}(),lineno:33}),0);c._fulfill()})(function(){return window.location.hash=i(s,q,a)})};o=function(){var e,f,g,i,j,k,l,m,n;e=window.location.hash;e=e.slice(4,e.length);j=e.split("|");i=null;s=null;q="";for(l=0,m=j.length;l<m;l++){g=j[l];n=g.split(":"),f=n[0],k=n[1];f===a&&(s=k);f===c&&(i=k);f===b&&(q=k)}if(!s&&!i){s=d[0];x();return}$("#books option[value='"+s+"']").attr("selected","selected");if(q!==""){v(!1);$("#searchbox").val(q)}$(".item").removeClass("bigger");if(i){t=i;$("body").addClass("detail-view");$("body").removeClass("list-view");r($(".item[rel="+t+"]"));$(".item").removeClass("shown");$(".item[rel="+t+"]").addClass("shown");$(".item[rel="+t+"]").addClass("bigger");return $("#items").isotope({filter:".shown"})}r(null);$("body").addClass("list-view");$("body").removeClass("detail-view");return h()};y=!1;v=function(a){a?$("#searchbox").val("חיפוש חופשי בתוך ההמלצות"):y&&$("#searchbox").val("");y=a;return $("#searchbox").toggleClass("watermark",a)};g=function(a){var b,c,g,h,i,j,k;n=a;d={};f={};e={};for(g=0,i=a.length;g<i;g++){b=a[g];d[b.gov.book]||(d[b.gov.book]={});d[b.gov.book][b.gov.chapter]=!0;k=b.gov.tags;for(h=0,j=k.length;h<j;h++){c=k[h];f[c]=1}e[b.gov.subject]=1}f=Object.keys(f);e=Object.keys(e);d=Object.keys(d);if(localStorage){localStorage.data=JSON.stringify(a);localStorage.all_books=JSON.stringify(d);localStorage.all_tags=JSON.stringify(f);localStorage.all_subjects=JSON.stringify(e)}return p()};l=!1;u=function(){var a,b,c,d,g,h,i;v(!0);$("#searchbox").change(function(){y?q="":q=$("#searchbox").val();return x()});$("#searchbox").focus(function(){return v(!1)});$("#searchbox").blur(function(){if($(this).val()==="")return v(!0)});$("#searchbar").submit(function(){return!1});a=[];for(d=0,h=f.length;d<h;d++){c=f[d];a.push({type:"tag",title:c})}for(g=0,i=e.length;g<i;g++){b=e[g];a.push({type:"subject",title:b})}return $("#searchbox").typeahead({source:a,items:20,matcher:function(a){return~a.title.indexOf(this.query)},valueof:function(a){return a.title},selected:function(a){q=a;return x()},highlighter:function(a){var b;b=a.title.replace(new RegExp("("+this.query+")","ig"),function(a,b){return"<strong>"+b+"</strong>"});if(a.type==="subject")return b;if(a.type==="tag")return"<span class='searchtag'><a href='#'>"+b+"</a></span>"}})};p=function(){var a,b,c,e,f,g,h,i,m,p,q=this;h=k.findDeferral(arguments);if(l)return;l=!0;$("#books").html("<option value=''>הכל</option>");for(m=0,p=d.length;m<p;m++){a=d[m];$("#books").append("<option value='"+a+"'>"+a+"</option>")}g=$("script[name=item]").html();e=$("script[name=list]").html();b=function(a){return Mustache.to_html(e,{items:a,linkify:function(){return function(a,b){a=b(a);return a=a.replace(/\[(.+)\]/,"<a href='$1'>קישור</a>")}}})};c=Mustache.to_html(g,{items:n,none_val:function(){return function(a,b){a=b(a);return a===""?"אין":a}},semicolon_list:function(){return function(a,c){a=c(a);a=a.split(";");return a=b(a)}},urlforslug:function(){return function(a,b){a=b(a);return j(a)}}});$("#items").html(c);$(".item").each(function(){var a,b,c,d,e,f,g,h,i,j;b=$(this).attr("implementation-status");(b==="STUCK"||b==="WORKAROUND")&&$(this).find(".buxa-header").addClass("bad");b==="FIXED"&&$(this).find(".buxa-header").addClass("good");d=function(a){return a<10?"0"+a:a};h=new Date;h=""+h.getFullYear()+"/"+d(h.getMonth())+"/"+d(h.getDay());$(this).find(".timeline .timeline-point:last").attr("data-duedate",h);g=$(this).find(".timeline .timeline-point");g.tsort({attr:"data-duedate",order:"asc"});g=$(this).find(".timeline .timeline-point");c=g.length;c===1?e=1:e=75/(c-1);j=[];for(a=i=0;0<=c?i<=c:i>=c;a=0<=c?++i:--i){f=$(g[a]);f.css("top",10+a*e+"%");f.tooltip({delay:{show:0,hide:1e3},placement:"bottom",title:f.html()});j.push(f.html(""))}return j});(function(a){i=new k.Deferrals(a,{parent:h,filename:"gov-watch.iced",funcname:"process_data"});setTimeout(i.defer({assign_fn:function(){return function(){return i.ret=arguments[0]}}(),lineno:272}),50);i._fulfill()})(function(){$.Isotope.prototype._positionAbs=function(a,b){return{right:a,top:b}};$("#items").isotope({itemSelector:".item",layoutMode:"masonry",transformsEnabled:!1,filter:".shown",getSortData:{chapter:function(a){return a.find(".chapter-text").text()},recommendation:function(a){return a.find(".recommendation-text").text()},budget:function(a){return-parseInt("0"+a.attr("cost"),10)},comments:function(a){return-parseInt("0"+a.find(".fb_comments_count").text(),10)},oneitem:function(a){return a.attr("rel")===t?0:1}}});u();$("#books").change(function(){s=$("#books").val();return x()});$("#sort").change(function(){var a;a=$("#sort").val();return $("#items").isotope({sortBy:a})});$(".item").click(function(){return x($(this).attr("rel"))});window.onhashchange=o;o();f={backdrop:!0,keyboard:!0,show:!1};$("#overview").modal(f);return $("#overview-close").click(function(){return $("#overview").modal("hide")})})};r=function(a){var b,c,d,e=this;c=k.findDeferral(arguments);$("fb\\:comments").remove();$("fb\\:like").remove();$(".item").removeClass("bigger");(function(e){if(!a)return e();a.addClass("bigger");$("#items").isotope("reLayout",function(){});t=a.attr("rel");b=j(t);a.append("<fb:like href='"+b+"' send='true' width='590' show_faces='true' action='recommend' font='tahoma'></fb:like>");a.append("<fb:comments href='"+b+"' num_posts='2' width='590'></fb:comments>");(function(b){d=new k.Deferrals(b,{parent:c,filename:"gov-watch.iced",funcname:"select_item"});window.FB?FB.XFBML.parse(a.get(0),d.defer({assign_fn:function(){return function(){return d.ret=arguments[0]}}(),lineno:344})):d.defer({assign_fn:function(){return function(){return d.ret=arguments[0]}}(),lineno:347});d._fulfill()})(function(){(function(a){d=new k.Deferrals(a,{parent:c,filename:"gov-watch.iced",funcname:"select_item"});setTimeout(d.defer({assign_fn:function(){return function(){return d.ret=arguments[0]}}(),lineno:347}),1e3);d._fulfill()})(function(){$(".item[rel="+t+"]").scrollintoview();$("#items").isotope("reLayout");(function(a){d=new k.Deferrals(a,{parent:c,filename:"gov-watch.iced",funcname:"select_item"});setTimeout(d.defer({assign_fn:function(){return function(){return d.ret=arguments[0]}}(),lineno:350}),1e3);d._fulfill()})(function(){return e($(".item[rel="+t+"]").scrollintoview())})})})})(function(){return $("#items").isotope("reLayout")})};h=function(){var a,b,c,d,e,f,g,h,i,j,l,m,o,p,r,u,v,w=this;h=k.findDeferral(arguments);c=RegExp(q,"ig");for(j=0,o=n.length;j<o;j++){d=n[j];f=d.slug;d=d.gov;e=q==="";if(q!==""){u=["recommendation","subject","result_metric","title","chapter","subchapter","responsible_authority"];for(l=0,p=u.length;l<p;l++){a=u[l];d[a]?b=d[a].indexOf(q)>=0:b=!1;e=e||b}v=d.tags;for(m=0,r=v.length;m<r;m++){g=v[m];g===q&&(e=!0)}}e=e&&(s===""||d.book===s);$(".item[rel="+f+"]").toggleClass("shown",e)}$("#items").isotope({filter:".shown"});(function(a){i=new k.Deferrals(a,{parent:h,filename:"gov-watch.iced",funcname:"do_search"});setTimeout(i.defer({assign_fn:function(){return function(){return i.ret=arguments[0]}}(),lineno:389}),1e3);i._fulfill()})(function(){return $(".item[rel="+t+"]").scrollintoview()})};m=function(){return $.get("/api",g,"json")};$(function(){try{n=JSON.parse(localStorage.data);d=JSON.parse(localStorage.all_books);f=JSON.parse(localStorage.all_tags);e=JSON.parse(localStorage.all_subjects);p();return setTimeout(m,1e4)}catch(a){return m()}})})).call(this);